#!/bin/bash
### $Id: install,v 1.1 2008-09-09 08:37:52 sfd Exp $

# install [OPTIONS] DEST

# install:  A script to create the working version of the Matrix
#           customization system.
# DEST:     The destination directory of the install
# OPTIONS:
#      -r:  install remotely on homer.u.washington.edu
#    -lkb:  also copy the necessary parts of the lkb from given directory
#
# Examples:
#      To install to a local directory:
#           ./install path/to/dest/
#      To install to a remote directory:
#           ./install user@host:/path/to/dest/
#      To install remotely on homer:
#           ./install -r my_branch
#       * Note that this is merely short for:
#           ./install uwcl@homer.u.washington.edu:~/public_html/my_branch
#      To install to www.delph-in.net/matrix:
#           ./install -r matrix/customize

homer_prefix="uwcl@homer.u.washington.edu:~/public_html/"

# parse command line
while [ "$1" = -l -o "$1" = -r -o "$1" = -lkb ]
do
    if [ "$1" = -r ]
    then
        installonhomer=true
    elif [ "$1" = -lkb ]
    then
        shift
        lkbdir="$1"
    fi
    shift
done

if [ $# != 1 ]
then
    echo "Usage: $0 [-r] <directory name>"
    exit 1
fi

dest="$1"

# check that Customization Root is defined
if [ -z $CUSTOMIZATIONROOT ]
then
    echo "Please: export CUSTOMIZATIONROOT=<your gmcs file>"
    exit 1
fi

# create temporary staging directory
tempdir=/tmp/matrix.$$

# the following will create the tempdir directory and fill it with
# with everything in the directories besides what's excluded.
rsync -a --exclude={CVS/,.svn/,regression_tests/,tests/,sql_profiles/,gmmt/,lisp/,*.pyc,.*,*.tmp~,local_testing,Version.lsp,install,matrix.py,def_check.py,profiles.py,randgram.py,tdltest.py} ${CUSTOMIZATIONROOT}/../ $tempdir

# create datestamp, matrix-types, and head-types files
date -u > $tempdir/datestamp
matrix_core=${CUSTOMIZATIONROOT}/../matrix-core/
cat $matrix_core/matrix.tdl | grep '^[^;].*:=' | sed 's/ *:=.*//g' | sort | uniq > $tempdir/matrix-types
cat $matrix_core/head-types.tdl | grep '^[^;].*:=' | sed 's/ *:=.*//g' | sort | uniq > $tempdir/head-types

# copy files to the temp directory
if [ "$installonhomer" ]
then
    dest="${homer_prefix}${dest}"
    # Redirect the root directory to matrix.cgi
    echo "Redirect /uwcl/$1/index.html /uwcl/$1/matrix.cgi" >> \
        $tempdir/.htaccess

    # Don't allow directory browsing
    echo "IndexIgnore */*" >> \
        $tempdir/.htaccess

    # Don't allow access to the saved choices.  (Even with directory
    # browsing turned off, somebody could guess the filename.)
    mkdir $tempdir/saved-choices
    echo "Option -Indexes" >> \
        $tempdir/saved-choices/.htaccess
fi

#If necessary, copy the lkb from the source directory, taking only what is needed
if [ "$lkbdir" ]
then
  mkdir $tempdir/delphin
  cp -rL $lkbdir/bin $tempdir/delphin
  lkbfiles=`ls -1 $lkbdir/lkb | sed '/^src$/ d'`
  echo $lkbfiles
  pushd $lkbdir/lkb
  cp -r $lkbfiles $tempdir/delphin
  popd
fi

#Finally rsync the tempdir to the destination
rsync -vaz $tempdir/ $dest
# The following command will also delete files at the destination that
# do not exist in tempdir. Not using for now because an incorrect
# destination could delete more than expected. This means that files
# such as sample-choices deleted locally won't be deleted remotely unless
# you do it manually.
#rsync -az --delete $tempdir/ $dest

# and clean up
rm -rf $tempdir
